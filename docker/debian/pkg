FROM docker.codingcafe.org/xkszltl/roaster/ubuntu:stage-font

ARG LABEL_BUILD_ID=Undefined
LABEL BUILD_ID=$LABEL_BUILD_ID

COPY [".", "/etc/roaster/scripts"]

RUN set -e; \
    export DEB_MAX_ATTEMPT=10; \
    for attempt in $(seq "$DEB_MAX_ATTEMPT" -1 0); do \
        [ "$attempt" -gt 0 ]; \
        ( \
            set -e; \
            sudo apt-get update -y; \
            sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade -y; \
        ) && break; \
        echo "Retrying... $(expr "$attempt" - 1) chance(s) left."; \
    done; \
    for attempt in $(seq "$DEB_MAX_ATTEMPT" -1 0); do \
        [ "$attempt" -gt 0 ]; \
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            asciidoc \
            apcupsd \
            apt-mirror \
            autoconf{,-archive} automake autopoint \
            axel \
            bash-completion \
            bc \
            binutils \
            bison \
            bmon \
            bsdmainutils \
            byacc{,-j} \
            bzip2 pbzip2 \
            ccache \
            cmake{,-curses-gui} \
            coreutils \
            cpio \
            curl \
            debmirror \
            default-jdk ant maven \
            diffutils \
            docker-{ce,compose} \
            dos2unix \
            expect \
            firewalld \
            flex \
            ftpsync \
            fuse libfuse-dev \
            g++{,-{9,10}} \
            gawk \
            gcc{,-{9,10}}-multilib \
            gdb \
            gettext \
            gfortran{,-{9,10}} \
            giflib-tools libgif-dev \
            git{,-{extras,lfs}} \
            gnome-keyring{,'-*'} \
            gnuplot \
            gperf \
            gstreamer1.0-tools libgstreamer1.0-dev \
            gzip \
            hdf5-{helpers,tools} h5utils libhdf5-{{,{mpi,mpich,openmpi}-}dev,doc} \
            htop \
            httping \
            ibutils infiniband-diags \
            icu-devtools \
            ifstat \
            iftop \
            iotop \
            iproute2{,-doc} \
            'iputils-*' \
            jq \
            lcov \
            ldap-utils slapd \
            lib{asan{5,6},lsan0,tsan0,ubsan1} \
            lib{atlas-base,boost-all,bz2,cairo2,edit,eigen3,ffi,fuse3,gflags,gif,google-glog,grpc++,gtest,harfbuzz,hiredis,hwloc,jemalloc,jpeg,jsoncpp,lapack,leveldb,lmdb,lzma,ncurses5,openblas,opencv,pango1.0,png,rados{,pp},rocksdb,snappy,ssl,tiff,utf8proc,yaml}-dev \
            libevent-dev \
            libfreetype{6,-dev} \
            libjpeg{-turbo-progs,62-turbo-dev} \
            liblz4-dev liblz4-tool \
            libnuma-dev numactl numad \
            libpapi-dev papi-tools \
            libprotobuf-dev protobuf-compiler \
            libpugixml-dev pugixml-doc\
            libtool \
            libudns-dev udns-utils \
            {llvm,clang{,-{format,tidy,tools}},lld}{,-9,-11} llvm-{9,11}-tools lldb{,-11} lib{c++{,abi},omp}{,-11}-dev \
            locales \
            locate \
            lshw \
            lsof \
            ltrace \
            m4 \
            make \
            moreutils \
            mtr \
            net-tools \
            ninja-build \
            openssh-{client,server} \
            pandoc \
            parallel \
            pass \
            pax-utils \
            pciutils \
            pigz \
            powertop \
            procps \
            pv \
            pybind11-dev \
            python3{,-pip} \
            qtbase5-dev \
            rapidjson-dev \
            redis{,-tools} \
            rdma-core rdmacm-utils librdmacm{1,-dev} \
            rng-tools5 \
            rsync \
            ruby-all-dev \
            samba{,-dev} smbclient smbldap-tools \
            sed \
            {selinux-basics,{selinux-policy,policycoreutils}'-*'} se{manage,module}-utils \
            socat \
            strace \
            software-properties-common \
            subversion-tools \
            sysfsutils \
            tar \
            time \
            tmux{,-plugin-manager} \
            tree \
            tuned{,'-*'} \
            txt2man \
            usbutils \
            util-linux \
            uuid-{dev,runtime} \
            valgrind{,-mpi} \
            vim{,-gtk3} \
            wget \
            whois \
            winbind \
            xz-utils \
            zfs-{dkms,initramfs,test} zfsutils-linux \
            zstd libzstd-dev \
        && break; \
        echo "Retrying... $(expr "$attempt" - 1) chance(s) left."; \
    done; \
    sudo apt-get autoremove -y; \
    sudo apt-get clean; \
    sudo update-alternatives --set libblas.so.3-x86_64-linux-gnu /usr/lib/x86_64-linux-gnu/atlas/libblas.so.3; \
    sudo update-alternatives --set liblapack.so.3-x86_64-linux-gnu /usr/lib/x86_64-linux-gnu/atlas/liblapack.so.3; \
    sudo parallel --will-cite < /dev/null; \
    truncate -s0 ~/.bash_history;
RUN /etc/roaster/scripts/setup.sh fpm
